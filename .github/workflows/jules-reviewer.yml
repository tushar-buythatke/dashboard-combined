name: Jules PR Reviewer

on:
  issue_comment:
    types: [created]

jobs:
  review:
    if: ${{ github.event.issue.pull_request && contains(github.event.comment.body, '/jules-review') }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
    
    steps:
      # 0. ACKNOWLEDGE THE COMMAND WITH A REACTION
      - name: Add Reaction to Comment
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMENT_ID: ${{ github.event.comment.id }}
          REPO: ${{ github.repository }}
        run: |
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/$REPO/issues/comments/$COMMENT_ID/reactions \
            -f content='rocket'
      # 1. RANDOMLY SELECT AN API KEY FROM THE POOL
      - name: Pick Random API Key
        id: resolve-key
        env:
          KEY_POOL: ${{ secrets.JULES_API_KEY_POOL }}
          PR_NUMBER: ${{ github.event.issue.number }}
          REPO: ${{ github.repository }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Ensure the pool isn't empty
          if [ -z "$KEY_POOL" ]; then
            gh pr comment $PR_NUMBER --repo "$REPO" --body "⚠️ The API key pool (\`JULES_API_KEY_POOL\`) is missing or empty."
            exit 1
          fi
          
          # Parse the JSON array and pick a random key using 'shuf'
          SELECTED_KEY=$(echo "$KEY_POOL" | jq -r '.[]' | shuf -n 1)
          
          if [ -z "$SELECTED_KEY" ] || [ "$SELECTED_KEY" == "null" ]; then
            gh pr comment $PR_NUMBER --repo "$REPO" --body "⚠️ Failed to parse a valid key from the \`JULES_API_KEY_POOL\`. Ensure it is formatted as a valid JSON array."
            exit 1
          fi
          
          # Mask the key so it NEVER shows up in GitHub logs
          echo "::add-mask::$SELECTED_KEY"
          echo "JULES_API_KEY=$SELECTED_KEY" >> $GITHUB_ENV

      # 2. GET BOTH THE PR BRANCH AND THE BASE BRANCH
      - name: Get PR Branch Context
        id: get-branch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_URL="${{ github.event.issue.pull_request.url }}"
          PR_DATA=$(curl -s -H "Authorization: token $GITHUB_TOKEN" $PR_URL)
          BRANCH_NAME=$(echo "$PR_DATA" | jq -r .head.ref)
          BASE_BRANCH=$(echo "$PR_DATA" | jq -r .base.ref)
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
          echo "BASE_BRANCH=$BASE_BRANCH" >> $GITHUB_ENV

      # 3. TRIGGER JULES
      - name: Start Jules Review Session
        id: start-session
        env:
          REPO_FULL_NAME: ${{ github.repository }}
        run: |
          RESPONSE=$(curl -s -X POST 'https://jules.googleapis.com/v1alpha/sessions' \
            -H "Content-Type: application/json" \
            -H "x-goog-api-key: $JULES_API_KEY" \
            -d '{
              "prompt": "You are a STRICT, READ-ONLY code reviewer. Do EXACTLY this:\n1. Run `git diff origin/'"$BASE_BRANCH"'...origin/'"$BRANCH_NAME"'` to see the exact code changes.\n2. ONLY review the specific files and lines that have changed in this diff.\n3. DO NOT run any bash commands like npm install, lint, or build. DO NOT run pre-commit steps.\n4. DO NOT modify, create, or edit any files (do not touch package-lock.json).\n5. Output your comprehensive review feedback in markdown format directly as a message to me, and then finish.",
              "sourceContext": {
                "source": "sources/github/'"$REPO_FULL_NAME"'",
                "githubRepoContext": {
                  "startingBranch": "'"$BRANCH_NAME"'"
                }
              },
              "title": "PR Review: Read-Only"
            }')
          
          SESSION_ID=$(echo $RESPONSE | jq -r '.id')
          echo "SESSION_ID=$SESSION_ID" >> $GITHUB_ENV
          echo "Started Jules Session: $SESSION_ID"

      # 4. WAIT FOR JULES AND POST THE COMMENT
      - name: Wait for Review & Post to PR
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.issue.number }}
          REPO: ${{ github.repository }}
        run: |
          echo "Waiting for Jules to finish..."
          
          for i in {1..40}; do
            sleep 15
            ACTIVITIES=$(curl -s "https://jules.googleapis.com/v1alpha/sessions/${SESSION_ID}/activities" -H "x-goog-api-key: $JULES_API_KEY")
            
            REVIEW_TEXT=$(echo "$ACTIVITIES" | jq -r '[.activities[]? | select((.originator == "agent" or .originator == "AGENT") and .agentMessaged != null) | .agentMessaged.agentMessage] | last // empty')
            ERROR_TEXT=$(echo "$ACTIVITIES" | jq -r '[.activities[]? | select(.sessionFailed != null) | .sessionFailed.reason] | last // empty')
            
            if [ -n "$ERROR_TEXT" ] && [ "$ERROR_TEXT" != "null" ]; then
              echo "Jules encountered an internal error!"
              gh pr comment $PR_NUMBER --repo "$REPO" --body "⚠️ **Jules encountered an internal error:** $ERROR_TEXT"
              exit 1
            fi
            
            if [ -n "$REVIEW_TEXT" ] && [ "$REVIEW_TEXT" != "null" ]; then
              echo "Review received! Posting to GitHub..."
              gh pr comment $PR_NUMBER --repo "$REPO" --body "$REVIEW_TEXT"
              exit 0
            fi
            
            echo "Jules is still thinking..."
          done
          
          gh pr comment $PR_NUMBER --repo "$REPO" --body "⚠️ Jules took longer than 10 minutes. The action timed out."
          exit 1